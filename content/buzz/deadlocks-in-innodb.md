Title: Про deadlocks в InnoDB и Django
Slug: deadlocks-in-innodb
Date: 2010-11-17 14:57
Category: texts
Tags: mysql, django
Lang: ru

Недавно попал в ситауцию, когда у меня возникали дедлоки InnoDB и Django. И случалось
это, когда я пробовал использовать `SELECT FOR UPDATE`.

Я провел расследование, покопался в исходниках, поигрался с MySQL консолью и
выяснил следующее.

![][Resized]

Во-первых, `SELECT FOR UPDATE` нормально работает только если в `WHERE` указаны
поля для которых построены индексы.

Во-вторых, если индексов нет то лок создается *НА ВСЮ ТАБЛИЦУ* даже если запрос
не возвращает результат.

В-третьих, даже если `SELECT FOR UPDATE` не вернул результата, надо обязательно
делать `COMMIT` для того, чтобы отпустить лок, а в моем случае Django не делала
коммит, так как для соединения не был проставлен флаг dirty.

В-четвертых, если на полях из `WHERE` есть индексы, то всё хорошо.

[Image]: http://farm3.static.flickr.com/2283/1831151460_03703bba9c_o.jpg
[Resized]: http://resizer.co/?image=http%3A%2F%2Ffarm3.static.flickr.com%2F2283%2F1831151460_03703bba9c_o.jpg&w=600
