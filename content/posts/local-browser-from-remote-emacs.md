Title: Как запускать локальный браузер из удаленного Emacs
Slug: local-browser-from-remote-emacs
Date: 2013-10-13 10:00
Category: texts
Tags: emacs, lisp
Lang: ru

Сегодня меня снова проперло продолжить изучать лисп, и я решил разобраться так со средой разработки. Заново начал мучать Emacs и Slime, попутно смотря давний [туториал Марко Барингера](http://www.youtube.com/watch?v=_B_4vhsmRRI) про Slime. Там он запускает Lisp на удаленной машине, а Emacs на локальной и все у него хорошо. Но я привык работать иначе, и запускаю редактор в консоли под тмуксом, на самом сервере.

Первая же проблема, с которой с столкнулся, следуя туториалу — невозможность просмотривать [Hyperspec][] документацию. Что ж, поставил [w3][] браузер, и тут же выяснил, что он разломан. Починить его оказалось не сложно, но тут же выяснилось, что он ломается еще в некоторых местах при просмотре некоторых дургих страниц. Плюнув на w3, я решил искать более человеческий способ открывать web страницы из emacs, запущенном на удаленном сервере. И решение не заставило себя долго ждать.

Я быстренько нашел функции типа `browse-url-*`, которые и использует slime, при попытке открыть документацию. Среди всего семейства меня заинтересовала функция `browse-url-generic`, позволяющая запускать любую команду. В итоге получилась такая конфигурация:

### На локальной машине

На OSX я поднял ssh сервер (что делается одной галочкой "Remote Login" в секции "Sharing" настроек), затем добавил в `~/.ssh/config` такие настройки, говорящие, что надо пробрасывать локальный 22 порт на удаленную машину:

    Host dev-host.example.com
    RemoteForward *:2022 localhost:22

### На разработческом сервере

Далее, на dev-host.example.com, я сгенерил пару ключей с помощью `ssh-keygen`, и поместил содержимое `~/.ssh/id_rsa.pu` в `.ssh/authorized_keys` на локальной машине (это пришлось сделать, потому что ssh-agent у меня странным образом глючил).

После чего, в `~/.ssh/config` были добавлены следующие строки, говорящие, что при коннекте к хосту `back`, на самом деле нужно идти на `localhost:2022`:

    Host back
    Hostname localhost
    Port 2022

И, в довершении всего, в конфиг Emacs пришлось добавить такой кусочек:

    :::lisp
    (setq browse-url-generic-program "ssh"
          browse-url-generic-args '("back" "open")
          browse-url-browser-function 'browse-url-generic)


В итоге, теперь вызовы `slime-hyperspec-lookup` или просто `browse-url`, приводят к тому, что страница открывается в табе моего браузера на локальной машинке!

[w3]: http://elpa.gnu.org/packages/w3.html
[hyperspec]: http://www.lispworks.com/documentation/HyperSpec/Front/index.htm